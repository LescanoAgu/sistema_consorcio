rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Función auxiliar: Verifica si el usuario actual está en la lista de admins del consorcio
    function isAdmin(consortiumId) {
      return request.auth.uid in get(/databases/$(database)/documents/consortiums/$(consortiumId)).data.adminIds;
    }

    // 1. Acceso de Usuario (Cada uno lee su propio perfil de accesos)
    match /user_access/{email} {
      allow read: if request.auth.token.email == email;
      // Escritura permitida temporalmente para registros automáticos
      allow write: if request.auth != null; 
    }

    // 2. Colección Consorcios
    match /consortiums/{consortiumId} {
      // Crear: Cualquier usuario logueado
      allow create: if request.auth != null;
      
      // Leer: Cualquier usuario logueado (necesario para listar y seleccionar)
      allow read: if request.auth != null;
      
      // Modificar/Borrar Consorcio: SOLO ADMINS
      allow update, delete: if isAdmin(consortiumId);

      // --- SUBCOLECCIONES (Unidades, Gastos, Historia) ---
      match /{document=**} {
        // Leer: Usuarios logueados (Vecinos y Admin)
        allow read: if request.auth != null;
        
        // Escribir/Borrar datos sensibles: SOLO ADMINS
        allow write: if isAdmin(consortiumId);
      }
      
      // --- EXCEPCIÓN: PAGOS ---
      // Los vecinos necesitan poder CREAR pagos (subir comprobante)
      match /payments/{paymentId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null; // Vecino informa pago
        allow update, delete: if isAdmin(consortiumId); // Solo admin aprueba o borra
      }
    }
  }
}